# 员工接口

## 4. 员工端接口

### 4.1 获取今日课程列表

#### 接口名称

获取员工今日课程列表接口

#### 接口路径

```txt
GET /api/employee/today-courses
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数：** 无

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "date": "2024-12-24",
    "courseCount": 2,
    "courses": [
      {
        "itemId": 3001,                      // plan_course_item.item_id
        "courseId": 101,                     // course.course_id
        "courseName": "船舶结构力学",         // course.course_name
        "courseDesc": "学习船舶结构设计...",  // course.course_desc
        "courseRequire": "需提前预习第3章",   // course.course_require
        "courseClass": "专业技能",            // course.course_class
        "classDate": "2024-12-24",           // plan_course_item.class_date
        "classBeginTime": "08:00:00",        // plan_course_item.class_begin_time
        "classEndTime": "10:00:00",          // plan_course_item.class_end_time
        "location": "培训楼301",              // plan_course_item.location
        "planId": 1,                         // training_plan.plan_id
        "planName": "2024年度技能提升计划",   // training_plan.plan_name
        "teacherId": 1002,                   // course.teacher_id
        "teacherName": "李老师",              // person.name（讲师）
        "hasEvaluated": false,               // 是否已自评（attendance_evaluation表查询）
        "status": "待上课"                   // 课程状态：待上课/已完成
      },
      {
        "itemId": 3002,
        "courseId": 102,
        "courseName": "船舶焊接技术",
        "courseDesc": "掌握船舶焊接方法...",
        "courseRequire": "需携带焊接防护用品",
        "courseClass": "专业技能",
        "classDate": "2024-12-24",
        "classBeginTime": "14:00:00",
        "classEndTime": "16:00:00",
        "location": "实训车间A",
        "planId": 1,
        "planName": "2024年度技能提升计划",
        "teacherId": 1003,
        "teacherName": "王工",
        "hasEvaluated": false,
        "status": "待上课"
      }
    ]
  }
}
```

**无课程响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "date": "2024-12-24",
    "courseCount": 0,
    "courses": []
  }
}
```

**无权限响应（403）：**

```json
{
  "code": 403,
  "message": "无权限访问，仅员工可查看",
  "data": null
}
```

---

### 4.2 获取员工课程表

#### 接口名称

获取员工课程表接口

#### 接口路径

```txt
GET /api/employee/schedule
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| startDate | string | 是 | 开始日期 | 2024-12-18 |
| endDate | string | 是 | 结束日期 | 2024-12-24 |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "startDate": "2024-12-18",
    "endDate": "2024-12-24",
    "totalCourses": 6,
    "schedule": [
      {
        "date": "2024-12-18",
        "dayOfWeek": "周一",
        "courses": [
          {
            "itemId": 3001,
            "courseId": 101,
            "courseName": "船舶结构力学",
            "courseDesc": "学习船舶结构设计原理",
            "courseRequire": "需提前预习第3章",
            "courseClass": "专业技能",
            "classBeginTime": "08:00:00",
            "classEndTime": "10:00:00",
            "location": "培训楼301",
            "planId": 1,
            "planName": "2024年度技能提升计划",
            "teacherId": 1002,
            "teacherName": "李老师",
            "hasEvaluated": true,
            "status": "已完成"
          },
          {
            "itemId": 3002,
            "courseId": 102,
            "courseName": "船舶焊接技术",
            "courseDesc": "掌握船舶焊接方法",
            "courseRequire": "需携带焊接防护用品",
            "courseClass": "专业技能",
            "classBeginTime": "14:00:00",
            "classEndTime": "16:00:00",
            "location": "实训车间A",
            "planId": 1,
            "planName": "2024年度技能提升计划",
            "teacherId": 1003,
            "teacherName": "王工",
            "hasEvaluated": false,
            "status": "已完成"
          }
        ]
      },
      {
        "date": "2024-12-19",
        "dayOfWeek": "周二",
        "courses": []
      }
      // ... 其他日期
    ]
  }
}
```

**参数错误响应（400）：**

```json
{
  "code": 400,
  "message": "日期参数错误",
  "data": null
}
```

---

### 4.3 获取待自评课程列表

#### 接口名称

获取待自评课程列表接口

#### 接口路径

```txt
GET /api/employee/pending-evaluations
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数（可选）：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| status | string | 否 | 筛选状态：pending（待自评）/all（全部） | pending |
| limit | number | 否 | 返回数量限制 | 10 |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "totalCount": 15,
    "pendingCount": 3,
    "courses": [
      {
        "itemId": 3001,
        "courseId": 101,
        "courseName": "船舶结构力学",
        "courseDesc": "学习船舶结构设计原理",
        "courseRequire": "需提前预习第3章",
        "courseClass": "专业技能",
        "classDate": "2024-12-20",
        "classBeginTime": "08:00:00",
        "classEndTime": "10:00:00",
        "location": "培训楼301",
        "planId": 1,
        "planName": "2024年度技能提升计划",
        "teacherId": 1002,
        "teacherName": "李老师",
        "hasEvaluated": false,
        "evaluationStatus": "pending"      // 评价状态：pending/evaluated
      },
      {
        "itemId": 3002,
        "courseId": 102,
        "courseName": "船舶焊接技术",
        "courseDesc": "掌握船舶焊接方法",
        "courseRequire": "需携带焊接防护用品",
        "courseClass": "专业技能",
        "classDate": "2024-12-19",
        "classBeginTime": "14:00:00",
        "classEndTime": "16:00:00",
        "location": "实训车间A",
        "planId": 1,
        "planName": "2024年度技能提升计划",
        "teacherId": 1003,
        "teacherName": "王工",
        "hasEvaluated": false,
        "evaluationStatus": "pending"
      }
    ]
  }
}
```

---

### 4.4 提交课程自评

#### 接口名称

提交课程自评接口

#### 逻辑描述

1. 前端提交自评信息，包括课程安排ID、学习心得、理解程度等
2. 后端验证 Token，获取 `person_id` 和角色信息
3. 权限验证：
   - 确认用户角色为"员工"
   - 验证该课程是否为该员工的课程（通过 plan_employee 验证）
4. 数据验证：
   - 课程安排ID必须存在
   - 自评内容不能为空
   - 课程必须已上完（课程日期 < 今日）
5. AI评分流程：
   - 将自评内容发送给AI接口（DeepSeek API）
   - AI根据内容分析学习掌握程度，生成0-100分的评分
   - 分数越高表示掌握度越高
6. 更新流程：
   - 在 `attendance_evaluation` 表中插入或更新记录
   - 存储 `self_score`（AI生成）和 `self_comment`（用户填写）
   - 如果已有讲师评分，重新计算加权得分
7. 异常情况：
   - 非员工角色：返回 403 无权限
   - 非本人课程：返回 403 无权限
   - 课程未上完：返回 400 课程尚未开始
   - 自评内容为空：返回 400 参数错误
   - AI服务异常：使用默认评分算法

#### 接口路径

```
POST /api/employee/submit-evaluation
```

#### 请求方式

POST

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**请求体：**

```json
{
  "itemId": 3001,                         // 必填，课程安排ID（plan_course_item.item_id）
  "selfComment": "通过本次课程...",       // 必填，自评内容/学习心得
  "understanding": 5,                     // 可选，理解程度（1-5）
  "difficulty": 3,                        // 可选，难度感受（1-5）
  "satisfaction": 5                       // 可选，满意度（1-5）
}
```

**参数说明：**

| 参数名 | 类型 | 必填 | 说明 | 数据库字段 |
|--------|------|------|------|-----------|
| itemId | number | 是 | 课程安排ID | attendance_evaluation.item_id |
| selfComment | string | 是 | 自评内容，最少50字，最长1000字 | attendance_evaluation.self_comment |
| understanding | number | 否 | 理解程度（1-5），辅助AI评分 | - |
| difficulty | number | 否 | 难度感受（1-5），辅助AI评分 | - |
| satisfaction | number | 否 | 满意度（1-5），辅助AI评分 | - |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "自评提交成功",
  "data": {
    "itemId": 3001,
    "courseId": 101,
    "courseName": "船舶结构力学",
    "selfScore": 87.5,                   // AI生成的自评分（attendance_evaluation.self_score）
    "selfComment": "通过本次课程...",    // 用户填写的自评内容
    "aiAnalysis": {                      // AI分析结果（可选）
      "keyPoints": ["掌握了基本概念", "理解了应用场景"],
      "weakPoints": ["计算部分需加强"],
      "suggestion": "建议多做练习题"
    },
    "teacherScore": null,                // 讲师评分（如果已评）
    "weightedScore": null,               // 加权得分（如果讲师已评分）
    "evaluatedAt": "2024-12-24 10:30:00"
  }
}
```

**参数错误响应（400）：**

```json
{
  "code": 400,
  "message": "自评内容不能少于50字",
  "data": null
}
```

**课程未开始响应（400）：**

```json
{
  "code": 400,
  "message": "课程尚未开始，暂不能自评",
  "data": null
}
```

**无权限响应（403）：**

```json
{
  "code": 403,
  "message": "无权限：该课程不属于您的课程安排",
  "data": null
}
```

---

### 4.5 获取员工成绩列表

#### 接口名称

获取员工成绩列表接口

#### 接口路径

```txt
GET /api/employee/scores
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数（可选）：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| planId | number | 否 | 培训计划ID筛选 | 1 |
| courseClass | string | 否 | 课程类型筛选 | 专业技能 |
| startDate | string | 否 | 开始日期 | 2024-01-01 |
| endDate | string | 否 | 结束日期 | 2024-12-31 |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "statistics": {
      "totalCourses": 20,                // 总课程数
      "completedCourses": 15,            // 已完成课程数（有成绩的）
      "pendingEvaluation": 3,            // 待自评课程数
      "averageScore": 87.5,              // 平均加权得分
      "maxScore": 98.5,                  // 最高分
      "minScore": 72.0                   // 最低分
    },
    "scores": [
      {
        "itemId": 3001,                  // plan_course_item.item_id
        "classDate": "2024-12-20",       // plan_course_item.class_date
        "classBeginTime": "08:00:00",    // plan_course_item.class_begin_time
        "classEndTime": "10:00:00",      // plan_course_item.class_end_time
        "location": "培训楼301",          // plan_course_item.location
        "planId": 1,                     // training_plan.plan_id
        "planName": "2024年度技能提升计划", // training_plan.plan_name
        "courseId": 101,                 // course.course_id
        "courseName": "船舶结构力学",     // course.course_name
        "courseClass": "专业技能",        // course.course_class
        "teacherName": "李老师",          // person.name（讲师）
        "selfScore": 85.5,               // attendance_evaluation.self_score
        "teacherScore": 88.0,            // attendance_evaluation.teacher_score
        "scoreRatio": 0.7,               // attendance_evaluation.score_ratio
        "weightedScore": 87.15,          // 加权得分 = 85.5 * 0.3 + 88 * 0.7
        "selfComment": "已充分理解...",   // attendance_evaluation.self_comment
        "teacherComment": "表现优秀",     // attendance_evaluation.teacher_comment
        "hasEvaluated": true,            // 是否已自评
        "hasTeacherScore": true          // 是否已有讲师评分
      },
      {
        "itemId": 3002,
        "classDate": "2024-12-19",
        "classBeginTime": "14:00:00",
        "classEndTime": "16:00:00",
        "location": "实训车间A",
        "planId": 1,
        "planName": "2024年度技能提升计划",
        "courseId": 102,
        "courseName": "船舶焊接技术",
        "courseClass": "专业技能",
        "teacherName": "王工",
        "selfScore": 90.0,
        "teacherScore": null,
        "scoreRatio": 0.7,
        "weightedScore": null,           // 讲师未评分，加权得分为null
        "selfComment": "实操部分很有收获...",
        "teacherComment": null,
        "hasEvaluated": true,
        "hasTeacherScore": false
      }
      // ... 更多成绩记录
    ]
  }
}
```

---

### 4.6 获取课程类型成绩分析

#### 接口名称

获取员工课程类型成绩分析接口

#### 接口路径

```txt
GET /api/employee/course-type-scores
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数：** 无

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "personId": 1001,
    "personName": "张三",
    "courseTypeScores": [
      {
        "courseClass": "专业技能",         // course.course_class
        "avgWeightedScore": 87.5,        // 该类型课程的平均加权得分
        "courseCount": 8,                // 该类型的课程数量
        "completedCount": 8,             // 已完成的课程数量
        "maxScore": 95.0,                // 该类型的最高分
        "minScore": 78.0                 // 该类型的最低分
      },
      {
        "courseClass": "安全培训",
        "avgWeightedScore": 92.3,
        "courseCount": 4,
        "completedCount": 4,
        "maxScore": 98.0,
        "minScore": 85.0
      },
      {
        "courseClass": "管理能力",
        "avgWeightedScore": 85.8,
        "courseCount": 3,
        "completedCount": 2,
        "maxScore": 90.0,
        "minScore": 82.0
      },
      {
        "courseClass": "团队协作",
        "avgWeightedScore": 88.5,
        "courseCount": 5,
        "completedCount": 5,
        "maxScore": 92.0,
        "minScore": 84.0
      }
    ],
    "radarData": {                       // 雷达图专用数据格式
      "indicators": [
        { "name": "专业技能", "max": 100 },
        { "name": "安全培训", "max": 100 },
        { "name": "管理能力", "max": 100 },
        { "name": "团队协作", "max": 100 }
      ],
      "values": [87.5, 92.3, 85.8, 88.5]
    }
  }
}
```

**无数据响应（200）：**

```json
{
  "code": 200,
  "message": "暂无成绩数据",
  "data": {
    "personId": 1001,
    "personName": "张三",
    "courseTypeScores": [],
    "radarData": {
      "indicators": [],
      "values": []
    }
  }
}
```

---

### 4.7 获取员工学习进度

#### 接口名称

获取员工学习进度接口

#### 接口路径

```txt
GET /api/employee/learning-progress
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数：** 无

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "personId": 1001,
    "personName": "张三",
    "overallProgress": {
      "totalPlans": 2,                   // 参与的培训计划总数
      "totalCourses": 20,                // 总课程数
      "completedCourses": 15,            // 已完成课程数
      "evaluatedCourses": 12,            // 已自评课程数
      "progressPercentage": 75.0,        // 完成百分比
      "averageScore": 87.5               // 平均分
    },
    "planProgress": [
      {
        "planId": 1,
        "planName": "2024年度技能提升计划",
        "planStatus": "进行中",
        "startDate": "2024-01-01",
        "endDate": "2024-12-31",
        "totalCourses": 15,
        "completedCourses": 12,
        "evaluatedCourses": 10,
        "progressPercentage": 80.0,
        "averageScore": 88.2
      },
      {
        "planId": 2,
        "planName": "安全培训专项计划",
        "planStatus": "进行中",
        "startDate": "2024-06-01",
        "endDate": "2024-08-31",
        "totalCourses": 5,
        "completedCourses": 3,
        "evaluatedCourses": 2,
        "progressPercentage": 60.0,
        "averageScore": 85.5
      }
    ],
    "recentCourses": [
      {
        "itemId": 3001,
        "courseName": "船舶结构力学",
        "classDate": "2024-12-20",
        "weightedScore": 87.15,
        "hasEvaluated": true
      },
      {
        "itemId": 3002,
        "courseName": "船舶焊接技术",
        "classDate": "2024-12-19",
        "weightedScore": 90.0,
        "hasEvaluated": true
      }
      // ... 最近5条学习记录
    ]
  }
}
```
