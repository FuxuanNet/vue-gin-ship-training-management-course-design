## 3. 讲师端接口

### 3.1 获取今日授课列表

#### 接口名称

获取讲师今日授课列表接口

#### 接口路径

```txt
GET /api/teacher/today-courses
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数：** 无

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "date": "2024-12-24",
    "courseCount": 2,
    "courses": [
      {
        "itemId": 3001,                      // plan_course_item.item_id
        "courseId": 101,                     // course.course_id
        "courseName": "船舶结构力学",         // course.course_name
        "courseDesc": "学习船舶结构设计...",  // course.course_desc
        "courseRequire": "需提前预习第3章",   // course.course_require
        "courseClass": "专业技能",            // course.course_class
        "classDate": "2024-12-24",           // plan_course_item.class_date
        "classBeginTime": "08:00:00",        // plan_course_item.class_begin_time
        "classEndTime": "10:00:00",          // plan_course_item.class_end_time
        "location": "培训楼301",              // plan_course_item.location
        "planId": 1,                         // training_plan.plan_id
        "planName": "2024年度技能提升计划",   // training_plan.plan_name
        "studentCount": 25,                  // 该课次的学员数量（attendance_evaluation表统计）
        "evaluatedCount": 10                 // 已评分学员数量
      },
      {
        "itemId": 3002,
        "courseId": 102,
        "courseName": "船舶焊接技术",
        "courseDesc": "掌握船舶焊接方法...",
        "courseRequire": "需携带焊接防护用品",
        "courseClass": "专业技能",
        "classDate": "2024-12-24",
        "classBeginTime": "14:00:00",
        "classEndTime": "16:00:00",
        "location": "实训车间A",
        "planId": 1,
        "planName": "2024年度技能提升计划",
        "studentCount": 20,
        "evaluatedCount": 0
      }
    ]
  }
}
```

**无授课响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "date": "2024-12-24",
    "courseCount": 0,
    "courses": []
  }
}
```

**无权限响应（403）：**

```json
{
  "code": 403,
  "message": "无权限访问，仅讲师可查看",
  "data": null
}
```

---

### 3.2 获取讲师授课表

#### 接口名称

获取讲师授课表接口

#### 接口路径

```
GET /api/teacher/schedule
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| startDate | string | 是 | 开始日期 | 2024-12-18 |
| endDate | string | 是 | 结束日期 | 2024-12-24 |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "startDate": "2024-12-18",
    "endDate": "2024-12-24",
    "totalCourses": 8,
    "schedule": [
      {
        "date": "2024-12-18",
        "dayOfWeek": "周一",
        "courses": [
          {
            "itemId": 3001,
            "courseId": 101,
            "courseName": "船舶结构力学",
            "courseDesc": "学习船舶结构设计原理",
            "courseRequire": "需提前预习第3章",
            "courseClass": "专业技能",
            "classBeginTime": "08:00:00",
            "classEndTime": "10:00:00",
            "location": "培训楼301",
            "planId": 1,
            "planName": "2024年度技能提升计划",
            "studentCount": 25,
            "evaluatedCount": 25
          }
        ]
      },
      {
        "date": "2024-12-19",
        "dayOfWeek": "周二",
        "courses": []
      }
      // ... 其他日期
    ]
  }
}
```

**参数错误响应（400）：**

```json
{
  "code": 400,
  "message": "日期参数错误",
  "data": null
}
```

---

### 3.3 获取待评分学员列表

#### 接口名称

获取待评分学员列表接口

#### 接口路径

```txt
GET /api/teacher/pending-evaluations
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数（可选）：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| courseId | number | 否 | 课程ID，筛选特定课程 | 101 |
| status | string | 否 | 筛选状态：pending（待评分）/all（全部） | pending |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "totalCount": 45,
    "pendingCount": 15,
    "courseItems": [
      {
        "itemId": 3001,
        "courseId": 101,
        "courseName": "船舶结构力学",
        "courseClass": "专业技能",
        "classDate": "2024-12-20",
        "classBeginTime": "08:00:00",
        "classEndTime": "10:00:00",
        "location": "培训楼301",
        "planName": "2024年度技能提升计划",
        "students": [
          {
            "personId": 1001,                  // person.person_id
            "personName": "张三",               // person.name
            "selfScore": 85.5,                 // attendance_evaluation.self_score
            "selfComment": "课程内容较难...",   // attendance_evaluation.self_comment
            "teacherScore": null,              // attendance_evaluation.teacher_score（未评分）
            "teacherComment": null,            // attendance_evaluation.teacher_comment
            "scoreRatio": 0.7,                 // attendance_evaluation.score_ratio
            "evaluatedAt": null,               // 评分时间（未评分为null）
            "status": "pending"                // 状态：pending/evaluated
          },
          {
            "personId": 1002,
            "personName": "李四",
            "selfScore": 92.0,
            "selfComment": "已充分理解课程内容",
            "teacherScore": 88.0,
            "teacherComment": "表现优秀，积极回答问题",
            "scoreRatio": 0.7,
            "evaluatedAt": "2024-12-21 10:30:00",
            "status": "evaluated"
          }
        ]
      }
      // ... 其他课程安排
    ]
  }
}
```

---

### 3.4 提交学员评分

#### 接口名称

提交学员评分接口

#### 逻辑描述

1. 前端提交评分信息，包括学员ID、课程安排ID、评分、评语等
2. 后端验证 Token，获取 `person_id`（讲师ID）和角色信息
3. 权限验证：
   - 确认用户角色为"讲师"
   - 验证该课程安排是否为该讲师负责（通过 course.teacher_id 验证）
4. 数据验证：
   - 评分范围：0-100
   - 评分占比范围：0-1
   - 学员ID和课程安排ID必须存在
5. 更新流程：
   - 更新 `attendance_evaluation` 表中对应记录的 `teacher_score`、`teacher_comment`、`score_ratio`
   - 如果使用AI评分功能，则根据评语调用AI接口生成分数
   - 记录评分时间
6. 计算加权得分：
   - `weighted_score = self_score * (1 - score_ratio) + teacher_score * score_ratio`
7. 异常情况：
   - 非讲师角色：返回 403 无权限
   - 非本讲师课程：返回 403 无权限
   - 评分超出范围：返回 400 参数错误
   - 学员或课程不存在：返回 404 未找到

#### 接口路径

```txt
POST /api/teacher/submit-evaluation
```

#### 请求方式

POST

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**请求体：**

```json
{
  "itemId": 3001,                    // 必填，课程安排ID（plan_course_item.item_id）
  "personId": 1001,                  // 必填，学员ID（person.person_id）
  "teacherScore": 88.0,              // 必填，讲师评分（0-100）
  "teacherComment": "表现优秀...",   // 可选，讲师评语
  "scoreRatio": 0.7,                 // 必填，讲师评分占比（0-1）
  "useAI": false                     // 可选，是否使用AI评分（根据评语生成分数）
}
```

**参数说明：**

| 参数名 | 类型 | 必填 | 说明 | 数据库字段 |
|--------|------|------|------|-----------|
| itemId | number | 是 | 课程安排ID | attendance_evaluation.item_id |
| personId | number | 是 | 学员ID | attendance_evaluation.person_id |
| teacherScore | number | 是 | 讲师评分（0-100） | attendance_evaluation.teacher_score |
| teacherComment | string | 否 | 讲师评语，最长500字 | attendance_evaluation.teacher_comment |
| scoreRatio | number | 是 | 讲师评分占比（0-1） | attendance_evaluation.score_ratio |
| useAI | boolean | 否 | 是否使用AI根据评语生成分数 | - |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "评分提交成功",
  "data": {
    "itemId": 3001,
    "personId": 1001,
    "personName": "张三",
    "selfScore": 85.5,
    "teacherScore": 88.0,
    "scoreRatio": 0.7,
    "weightedScore": 87.15,              // 加权得分 = 85.5 * 0.3 + 88 * 0.7
    "teacherComment": "表现优秀，积极回答问题",
    "evaluatedAt": "2024-12-24 10:30:00"
  }
}
```

**使用AI评分成功响应（200）：**
```json
{
  "code": 200,
  "message": "AI评分完成",
  "data": {
    "itemId": 3001,
    "personId": 1001,
    "personName": "张三",
    "selfScore": 85.5,
    "teacherScore": 86.5,                // AI生成的分数
    "scoreRatio": 0.7,
    "weightedScore": 86.2,
    "teacherComment": "表现优秀，积极回答问题",
    "aiGenerated": true,                 // 标识为AI生成
    "evaluatedAt": "2024-12-24 10:30:00"
  }
}
```

**参数错误响应（400）：**

```json
{
  "code": 400,
  "message": "评分必须在0-100之间",
  "data": null
}
```

**无权限响应（403）：**

```json
{
  "code": 403,
  "message": "无权限：该课程不是您负责的课程",
  "data": null
}
```

**未找到响应（404）：**

```json
{
  "code": 404,
  "message": "课程安排或学员不存在",
  "data": null
}
```

---

### 3.5 批量提交评分

#### 接口名称

批量提交学员评分接口

#### 逻辑描述

1. 前端提交多个学员的评分信息数组
2. 后端验证 Token 和讲师权限
3. 对每个评分记录进行验证和权限检查
4. 批量更新 `attendance_evaluation` 表
5. 使用事务确保数据一致性：
   - 全部成功则提交事务
   - 任一失败则回滚事务
6. 返回每条记录的处理结果

#### 接口路径

```txt
POST /api/teacher/batch-evaluation
```

#### 请求方式

POST

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**请求体：**

```json
{
  "evaluations": [
    {
      "itemId": 3001,
      "personId": 1001,
      "teacherScore": 88.0,
      "teacherComment": "表现优秀",
      "scoreRatio": 0.7
    },
    {
      "itemId": 3001,
      "personId": 1002,
      "teacherScore": 92.0,
      "teacherComment": "非常出色",
      "scoreRatio": 0.7
    }
  ]
}
```

#### 返回值

**成功响应（200）：**
```json
{
  "code": 200,
  "message": "批量评分成功",
  "data": {
    "totalCount": 2,
    "successCount": 2,
    "failCount": 0,
    "results": [
      {
        "itemId": 3001,
        "personId": 1001,
        "status": "success",
        "weightedScore": 87.15
      },
      {
        "itemId": 3001,
        "personId": 1002,
        "status": "success",
        "weightedScore": 90.85
      }
    ]
  }
}
```

---

### 3.6 设置评分占比

#### 接口名称

设置课程评分占比接口

#### 逻辑描述

1. 前端提交课程安排ID和新的评分占比
2. 后端验证 Token 和讲师权限
3. 权限验证：确认该课程为该讲师负责
4. 更新该课程安排下所有学员的评分占比（`attendance_evaluation.score_ratio`）
5. 重新计算所有学员的加权得分
6. 异常情况：
   - 评分占比超出范围（0-1）：返回 400
   - 非本讲师课程：返回 403

#### 接口路径

```txt
PUT /api/teacher/score-ratio
```

#### 请求方式

PUT

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**请求体：**

```json
{
  "itemId": 3001,          // 必填，课程安排ID
  "scoreRatio": 0.8        // 必填，讲师评分占比（0-1）
}
```

**参数说明：**

| 参数名 | 类型 | 必填 | 说明 | 数据库字段 |
|--------|------|------|------|-----------|
| itemId | number | 是 | 课程安排ID | plan_course_item.item_id |
| scoreRatio | number | 是 | 讲师评分占比，范围0-1 | attendance_evaluation.score_ratio |

#### 返回值

**成功响应（200）：**
```json
{
  "code": 200,
  "message": "评分占比设置成功",
  "data": {
    "itemId": 3001,
    "courseName": "船舶结构力学",
    "scoreRatio": 0.8,
    "affectedStudents": 25,
    "updatedAt": "2024-12-24 10:30:00"
  }
}
```

---

### 3.7 获取课程成绩统计

#### 接口名称

获取讲师课程成绩统计接口

#### 逻辑描述

1. 前端请求指定课程的成绩统计信息
2. 后端验证 Token 和讲师权限
3. 权限验证：确认该课程为该讲师负责
4. 查询流程：
   - 查询该课程的所有课程安排（`plan_course_item` 表）
   - 查询所有学员的评价记录（`attendance_evaluation` 表）
   - 计算统计数据：平均分、最高分、最低分、及格率等
5. 数据组织：
   - 按课次统计
   - 按学员统计
   - 整体统计
6. 支持数据可视化所需的格式

#### 接口路径

```txt
GET /api/teacher/course-statistics
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数：**
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| courseId | number | 是 | 课程ID | 101 |

#### 返回值

**成功响应（200）：**
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "courseId": 101,
    "courseName": "船舶结构力学",
    "courseClass": "专业技能",
    "teacherName": "李老师",
    "statistics": {
      "totalClasses": 8,                   // 总课次数
      "totalStudents": 25,                 // 总学员数
      "averageScore": 87.5,                // 平均分
      "maxScore": 98.5,                    // 最高分
      "minScore": 65.0,                    // 最低分
      "passRate": 96.0,                    // 及格率（60分及以上）
      "excellentRate": 72.0,               // 优秀率（85分及以上）
      "scoreDistribution": {               // 分数分布
        "0-59": 1,
        "60-69": 2,
        "70-79": 5,
        "80-89": 10,
        "90-100": 7
      }
    },
    "classStat": [
      {
        "itemId": 3001,
        "classDate": "2024-12-18",
        "location": "培训楼301",
        "studentCount": 25,
        "averageScore": 86.5,
        "evaluatedCount": 25
      }
      // ... 其他课次
    ],
    "studentScores": [
      {
        "personId": 1001,
        "personName": "张三",
        "classCount": 8,                   // 上课次数
        "averageScore": 87.5,              // 该学员在本课程的平均分
        "latestScore": 88.0,               // 最近一次得分
        "trend": "up"                      // 趋势：up/down/stable
      }
      // ... 其他学员
    ]
  }
}
```

**无权限响应（403）：**

```json
{
  "code": 403,
  "message": "无权限：该课程不是您负责的课程",
  "data": null
}
```

---

### 3.8 获取讲师授课统计

#### 接口名称

获取讲师整体授课统计接口

#### 接口路径

```txt
GET /api/teacher/teaching-statistics
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数（可选）：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| startDate | string | 否 | 开始日期 | 2024-01-01 |
| endDate | string | 否 | 结束日期 | 2024-12-31 |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "teacherId": 1002,
    "teacherName": "李老师",
    "period": {
      "startDate": "2024-01-01",
      "endDate": "2024-12-31"
    },
    "statistics": {
      "courseCount": 5,                    // 主讲课程数
      "classCount": 32,                    // 总授课次数
      "studentCount": 45,                  // 教授学员总数（去重）
      "totalHours": 64,                    // 总授课时长（小时）
      "averageTeachingScore": 92.3,        // 平均教学评分
      "evaluationRate": 98.5,              // 评分完成率
      "courseTypeDistribution": [          // 课程类型分布
        {
          "courseClass": "专业技能",
          "courseCount": 3,
          "averageScore": 91.5
        },
        {
          "courseClass": "安全培训",
          "courseCount": 2,
          "averageScore": 93.8
        }
      ]
    },
    "recentClasses": [                     // 最近授课
      {
        "itemId": 3001,
        "courseName": "船舶结构力学",
        "classDate": "2024-12-24",
        "studentCount": 25,
        "evaluatedCount": 25,
        "averageScore": 87.5
      }
      // ... 最近5次授课
    ]
  }
}
```

---
