# 大纲制定者接口

## 5. 课程大纲制定者端接口

### 5.1 获取培训计划列表

#### 接口名称

获取培训计划列表接口

#### 接口路径

```txt
GET /api/planner/plans
```

#### 请求方式

GET

#### 输入参数

**请求头：**
```
Authorization: Bearer <token>
```

**查询参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | number | 否 | 页码，默认1 |
| pageSize | number | 否 | 每页数量，默认10 |
| status | string | 否 | 计划状态筛选：规划中/进行中/已完成 |
| startDate | string | 否 | 开始日期筛选（YYYY-MM-DD） |
| endDate | string | 否 | 结束日期筛选（YYYY-MM-DD） |
| keyword | string | 否 | 计划名称关键词搜索 |
| sortBy | string | 否 | 排序字段：plan_start_datetime/plan_end_datetime，默认plan_start_datetime |
| sortOrder | string | 否 | 排序方向：asc/desc，默认desc |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total": 25,
    "page": 1,
    "pageSize": 10,
    "list": [
      {
        "planId": 1001,
        "planName": "2024年新员工培训计划",
        "planStatus": "进行中",
        "planStartDatetime": "2024-01-01 09:00:00",
        "planEndDatetime": "2024-06-30 18:00:00",
        "creatorId": 2001,
        "creatorName": "张主管",
        "employeeCount": 50,
        "courseCount": 12
      }
    ]
  }
}
```

**参数说明（数据库字段映射）：**

| 前端字段 | 数据库字段 | 说明 |
|---------|-----------|------|
| planId | training_plan.plan_id | 培训计划ID |
| planName | training_plan.plan_name | 培训计划名称 |
| planStatus | training_plan.plan_status | 计划状态 |
| planStartDatetime | training_plan.plan_start_datetime | 开始时间 |
| planEndDatetime | training_plan.plan_end_datetime | 结束时间 |
| creatorId | training_plan.creator_id | 制定人ID |
| creatorName | person.name | 制定人姓名 |
| employeeCount | COUNT(plan_employee.person_id) | 参与员工数 |
| courseCount | COUNT(plan_course_item.item_id) | 课程数 |

**无权限响应（403）：**

```json
{
  "code": 403,
  "message": "无权限访问",
  "data": null
}
```

---

### 5.2 创建培训计划

#### 接口名称

创建培训计划接口

#### 接口路径

```txt
POST /api/planner/plans
```

#### 请求方式

POST

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**请求体：**

```json
{
  "planName": "string",              // 必填，计划名称
  "planStatus": "string",            // 必填，计划状态：规划中/进行中/已完成
  "planStartDatetime": "string",     // 必填，开始时间（YYYY-MM-DD HH:mm:ss）
  "planEndDatetime": "string"        // 必填，结束时间（YYYY-MM-DD HH:mm:ss）
}
```

**参数说明：**

| 参数名 | 类型 | 必填 | 说明 | 数据库字段 |
|--------|------|------|------|-----------|
| planName | string | 是 | 计划名称，长度1-50字符 | training_plan.plan_name |
| planStatus | string | 是 | 计划状态：规划中/进行中/已完成 | training_plan.plan_status |
| planStartDatetime | string | 是 | 开始时间，格式YYYY-MM-DD HH:mm:ss | training_plan.plan_start_datetime |
| planEndDatetime | string | 是 | 结束时间，格式YYYY-MM-DD HH:mm:ss | training_plan.plan_end_datetime |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "planId": 1001,
    "planName": "2024年新员工培训计划",
    "planStatus": "规划中",
    "planStartDatetime": "2024-01-01 09:00:00",
    "planEndDatetime": "2024-06-30 18:00:00",
    "creatorId": 2001,
    "creatorName": "张主管"
  }
}
```

**参数错误响应（400）：**

```json
{
  "code": 400,
  "message": "开始时间必须早于结束时间",
  "data": null
}
```

---

### 5.3 修改培训计划

#### 接口名称

修改培训计划接口

#### 接口路径

```txt
PUT /api/planner/plans/:planId
```

#### 请求方式

PUT

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**路径参数：**

| 参数名 | 类型 | 说明 | 数据库字段 |
|--------|------|------|-----------|
| planId | number | 培训计划ID | training_plan.plan_id |

**请求体：**

```json
{
  "planName": "string",              // 可选，计划名称
  "planStatus": "string",            // 可选，计划状态
  "planStartDatetime": "string",     // 可选，开始时间
  "planEndDatetime": "string"        // 可选，结束时间
}
```

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "修改成功",
  "data": {
    "planId": 1001,
    "planName": "2024年新员工培训计划（修订版）",
    "planStatus": "进行中",
    "planStartDatetime": "2024-01-01 09:00:00",
    "planEndDatetime": "2024-06-30 18:00:00",
    "creatorId": 2001,
    "creatorName": "张主管"
  }
}
```

**计划不存在响应（404）：**

```json
{
  "code": 404,
  "message": "培训计划不存在",
  "data": null
}
```

---

### 5.4 删除培训计划

#### 接口名称

删除培训计划接口

#### 接口路径

```txt
DELETE /api/planner/plans/:planId
```

#### 请求方式

DELETE

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**路径参数：**

| 参数名 | 类型 | 说明 | 数据库字段 |
|--------|------|------|-----------|
| planId | number | 培训计划ID | training_plan.plan_id |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**存在关联数据响应（400）：**

```json
{
  "code": 400,
  "message": "无法删除，该计划下存在课程安排或关联员工，请先删除相关数据",
  "data": null
}
```

---

### 5.5 获取培训计划详情

#### 接口名称

获取培训计划详情接口

#### 接口路径

```txt
GET /api/planner/plans/:planId
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**路径参数：**

| 参数名 | 类型 | 说明 | 数据库字段 |
|--------|------|------|-----------|
| planId | number | 培训计划ID | training_plan.plan_id |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "planId": 1001,
    "planName": "2024年新员工培训计划",
    "planStatus": "进行中",
    "planStartDatetime": "2024-01-01 09:00:00",
    "planEndDatetime": "2024-06-30 18:00:00",
    "creatorId": 2001,
    "creatorName": "张主管",
    "courseItems": [
      {
        "itemId": 10001,
        "courseId": 5001,
        "courseName": "船舶安全基础",
        "classDate": "2024-01-15",
        "classBeginTime": "09:00:00",
        "classEndTime": "11:00:00",
        "location": "培训室A"
      }
    ],
    "employees": [
      {
        "personId": 3001,
        "name": "王员工"
      }
    ]
  }
}
```

**参数说明（数据库字段映射）：**

| 前端字段 | 数据库字段 | 说明 |
|---------|-----------|------|
| courseItems[].itemId | plan_course_item.item_id | 课程安排ID |
| courseItems[].courseId | plan_course_item.course_id | 课程ID |
| courseItems[].courseName | course.course_name | 课程名称 |
| courseItems[].classDate | plan_course_item.class_date | 上课日期 |
| courseItems[].classBeginTime | plan_course_item.class_begin_time | 开始时间 |
| courseItems[].classEndTime | plan_course_item.class_end_time | 结束时间 |
| courseItems[].location | plan_course_item.location | 上课地点 |
| employees[].personId | plan_employee.person_id | 员工ID |
| employees[].name | person.name | 员工姓名 |

---

### 5.6 为培训计划添加员工

#### 接口名称

为培训计划添加员工接口

#### 逻辑描述

1. 前端提交计划ID和员工ID列表，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可操作）
3. 验证 `plan_id` 是否存在
4. 验证员工ID列表的合法性：
   - 检查所有员工ID是否存在
   - 检查员工角色是否为"员工"
5. 检查员工是否已关联到该计划（避免重复添加）
6. 批量插入 `plan_employee` 表
7. 返回添加成功信息
8. 异常情况：
   - 计划不存在：返回 "培训计划不存在"
   - 员工不存在或角色不对：返回具体错误信息

#### 接口路径

```txt
POST /api/planner/plans/:planId/employees
```

#### 请求方式

POST

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**路径参数：**

| 参数名 | 类型 | 说明 | 数据库字段 |
|--------|------|------|-----------|
| planId | number | 培训计划ID | plan_employee.plan_id |

**请求体：**

```json
{
  "employeeIds": [3001, 3002, 3003]  // 必填，员工ID数组
}
```

**参数说明：**

| 参数名 | 类型 | 必填 | 说明 | 数据库字段 |
|--------|------|------|------|-----------|
| employeeIds | array | 是 | 员工ID数组 | plan_employee.person_id |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "添加成功",
  "data": {
    "addedCount": 3,
    "skippedCount": 0
  }
}
```

**部分成功响应（200）：**

```json
{
  "code": 200,
  "message": "添加完成，部分员工已存在",
  "data": {
    "addedCount": 2,
    "skippedCount": 1
  }
}
```

---

### 5.7 从培训计划移除员工

#### 接口名称

从培训计划移除员工接口

#### 逻辑描述

1. 前端提交计划ID和员工ID，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可操作）
3. 验证 `plan_id` 和 `person_id` 是否存在
4. 检查该员工是否已有课程评价记录（`attendance_evaluation` 表）
5. 如果已有评价记录，返回警告（建议不要删除，或提供强制删除选项）
6. 删除 `plan_employee` 表对应记录
7. 如果强制删除，同时删除 `attendance_evaluation` 表对应记录
8. 返回删除成功信息
9. 异常情况：
   - 员工不在该计划中：返回 "员工不在该培训计划中"

#### 接口路径

```txt
DELETE /api/planner/plans/:planId/employees/:employeeId
```

#### 请求方式

DELETE

#### 输入参数

**请求头：**
```
Authorization: Bearer <token>
```

**路径参数：**

| 参数名 | 类型 | 说明 | 数据库字段 |
|--------|------|------|-----------|
| planId | number | 培训计划ID | plan_employee.plan_id |
| employeeId | number | 员工ID | plan_employee.person_id |

**查询参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| force | boolean | 否 | 是否强制删除（同时删除评价记录），默认false |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "移除成功",
  "data": null
}
```

**存在评价记录警告响应（400）：**

```json
{
  "code": 400,
  "message": "该员工已有课程评价记录，建议不要移除。如需强制删除，请添加force=true参数",
  "data": {
    "evaluationCount": 5
  }
}
```

---

### 5.8 获取课程列表

#### 接口名称

获取课程列表接口

#### 逻辑描述

1. 前端请求课程列表，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可访问）
3. 查询 `course` 表，获取所有课程
4. 关联查询 `person` 表，获取主讲讲师姓名
5. 关联查询 `plan_course_item` 表，统计每个课程的安排次数
6. 支持分页、筛选（按课程类型）、排序
7. 返回课程列表
8. 异常情况：
   - 无权限：返回 "无权限访问"

#### 接口路径

```txt
GET /api/planner/courses
```

#### 请求方式

GET

#### 输入参数

**请求头：**
```
Authorization: Bearer <token>
```

**查询参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | number | 否 | 页码，默认1 |
| pageSize | number | 否 | 每页数量，默认10 |
| courseClass | string | 否 | 课程类型筛选 |
| keyword | string | 否 | 课程名称关键词搜索 |
| teacherId | number | 否 | 按讲师筛选 |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total": 50,
    "page": 1,
    "pageSize": 10,
    "list": [
      {
        "courseId": 5001,
        "courseName": "船舶安全基础",
        "courseDesc": "介绍船舶安全的基本知识和操作规范",
        "courseRequire": "无特殊要求",
        "courseClass": "安全培训",
        "teacherId": 4001,
        "teacherName": "李老师",
        "scheduledCount": 8
      }
    ]
  }
}
```

**参数说明（数据库字段映射）：**
| 前端字段 | 数据库字段 | 说明 |
|---------|-----------|------|
| courseId | course.course_id | 课程ID |
| courseName | course.course_name | 课程名称 |
| courseDesc | course.course_desc | 课程描述 |
| courseRequire | course.course_require | 课程要求 |
| courseClass | course.course_class | 课程类型 |
| teacherId | course.teacher_id | 讲师ID |
| teacherName | person.name | 讲师姓名 |
| scheduledCount | COUNT(plan_course_item.item_id) | 安排次数 |

---

### 5.9 创建课程

#### 接口名称

创建课程接口

#### 逻辑描述

1. 前端提交课程信息，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可创建）
3. 验证数据合法性：
   - 课程名称不为空，长度1-50字符
   - 讲师ID存在且角色为"讲师"
4. 生成 `course_id`（自增）
5. 插入 `course` 表
6. 返回新创建的课程信息
7. 异常情况：
   - 讲师不存在或角色不对：返回 "讲师不存在或角色错误"
   - 参数验证失败：返回具体错误信息

#### 接口路径

```txt
POST /api/planner/courses
```

#### 请求方式

POST

#### 输入参数

**请求头：**
```
Authorization: Bearer <token>
```

**请求体：**

```json
{
  "courseName": "string",        // 必填，课程名称
  "courseDesc": "string",        // 可选，课程描述
  "courseRequire": "string",     // 可选，课程要求
  "courseClass": "string",       // 必填，课程类型
  "teacherId": number            // 必填，讲师ID
}
```

**参数说明：**

| 参数名 | 类型 | 必填 | 说明 | 数据库字段 |
|--------|------|------|------|-----------|
| courseName | string | 是 | 课程名称，长度1-50字符 | course.course_name |
| courseDesc | string | 否 | 课程描述，长度最多100字符 | course.course_desc |
| courseRequire | string | 否 | 课程要求，长度最多500字符 | course.course_require |
| courseClass | string | 是 | 课程类型，长度最多20字符 | course.course_class |
| teacherId | number | 是 | 讲师ID | course.teacher_id |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "courseId": 5001,
    "courseName": "船舶安全基础",
    "courseDesc": "介绍船舶安全的基本知识和操作规范",
    "courseRequire": "无特殊要求",
    "courseClass": "安全培训",
    "teacherId": 4001,
    "teacherName": "李老师"
  }
}
```

**讲师错误响应（400）：**

```json
{
  "code": 400,
  "message": "讲师不存在或角色错误",
  "data": null
}
```

---

### 5.10 修改课程

#### 接口名称

修改课程接口

#### 逻辑描述

1. 前端提交修改的课程信息，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可修改）
3. 验证 `course_id` 是否存在
4. 验证数据合法性（同创建接口）
5. 更新 `course` 表对应记录
6. 返回更新后的课程信息
7. 异常情况：
   - 课程不存在：返回 "课程不存在"

#### 接口路径

```txt
PUT /api/planner/courses/:courseId
```

#### 请求方式

PUT

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**路径参数：**

| 参数名 | 类型 | 说明 | 数据库字段 |
|--------|------|------|-----------|
| courseId | number | 课程ID | course.course_id |

**请求体：**

```json
{
  "courseName": "string",        // 可选，课程名称
  "courseDesc": "string",        // 可选，课程描述
  "courseRequire": "string",     // 可选，课程要求
  "courseClass": "string",       // 可选，课程类型
  "teacherId": number            // 可选，讲师ID
}
```

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "修改成功",
  "data": {
    "courseId": 5001,
    "courseName": "船舶安全基础（修订版）",
    "courseDesc": "介绍船舶安全的基本知识和操作规范",
    "courseRequire": "需提前预习相关资料",
    "courseClass": "安全培训",
    "teacherId": 4001,
    "teacherName": "李老师"
  }
}
```

---

### 5.11 删除课程

#### 接口名称

删除课程接口

#### 逻辑描述

1. 前端提交要删除的课程ID，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可删除）
3. 验证 `course_id` 是否存在
4. 检查是否存在关联数据：
   - 检查 `plan_course_item` 表，是否有课程安排
5. 如果存在关联数据，返回错误提示
6. 如果无关联数据，删除 `course` 表对应记录
7. 返回删除成功信息
8. 异常情况：
   - 课程不存在：返回 "课程不存在"
   - 存在关联数据：返回 "无法删除，存在课程安排"

#### 接口路径

```txt
DELETE /api/planner/courses/:courseId
```

#### 请求方式

DELETE

#### 输入参数

**请求头：**
```txt
Authorization: Bearer <token>
```

**路径参数：**
| 参数名 | 类型 | 说明 | 数据库字段 |
|--------|------|------|-----------|
| courseId | number | 课程ID | course.course_id |

#### 返回值

**成功响应（200）：**
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**存在关联数据响应（400）：**
```json
{
  "code": 400,
  "message": "无法删除，该课程已被安排到培训计划中",
  "data": {
    "scheduledCount": 5
  }
}
```

---

### 5.12 获取课程安排列表

#### 接口名称

获取课程安排列表接口

#### 逻辑描述

1. 前端请求课程安排列表，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可访问）
3. 查询 `plan_course_item` 表，获取所有课程安排
4. 关联查询 `training_plan` 表，获取计划名称
5. 关联查询 `course` 表，获取课程详细信息
6. 关联查询 `person` 表，获取讲师姓名
7. 支持分页、筛选（按计划、按课程、按日期范围）、排序
8. 返回课程安排列表
9. 异常情况：
   - 无权限：返回 "无权限访问"

#### 接口路径

```txt
GET /api/planner/course-items
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | number | 否 | 页码，默认1 |
| pageSize | number | 否 | 每页数量，默认20 |
| planId | number | 否 | 按培训计划筛选 |
| courseId | number | 否 | 按课程筛选 |
| startDate | string | 否 | 开始日期筛选（YYYY-MM-DD） |
| endDate | string | 否 | 结束日期筛选（YYYY-MM-DD） |
| sortBy | string | 否 | 排序字段：class_date，默认class_date |
| sortOrder | string | 否 | 排序方向：asc/desc，默认asc |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total": 120,
    "page": 1,
    "pageSize": 20,
    "list": [
      {
        "itemId": 10001,
        "planId": 1001,
        "planName": "2024年新员工培训计划",
        "courseId": 5001,
        "courseName": "船舶安全基础",
        "courseClass": "安全培训",
        "teacherId": 4001,
        "teacherName": "李老师",
        "classDate": "2024-01-15",
        "classBeginTime": "09:00:00",
        "classEndTime": "11:00:00",
        "location": "培训室A"
      }
    ]
  }
}
```

**参数说明（数据库字段映射）：**

| 前端字段 | 数据库字段 | 说明 |
|---------|-----------|------|
| itemId | plan_course_item.item_id | 课程安排ID |
| planId | plan_course_item.plan_id | 培训计划ID |
| planName | training_plan.plan_name | 培训计划名称 |
| courseId | plan_course_item.course_id | 课程ID |
| courseName | course.course_name | 课程名称 |
| courseClass | course.course_class | 课程类型 |
| teacherId | course.teacher_id | 讲师ID |
| teacherName | person.name | 讲师姓名 |
| classDate | plan_course_item.class_date | 上课日期 |
| classBeginTime | plan_course_item.class_begin_time | 开始时间 |
| classEndTime | plan_course_item.class_end_time | 结束时间 |
| location | plan_course_item.location | 上课地点 |

---

### 5.13 创建课程安排

#### 接口名称

创建课程安排接口

#### 逻辑描述

1. 前端提交课程安排信息，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可创建）
3. 验证数据合法性：
   - `plan_id` 和 `course_id` 是否存在
   - 上课日期是否在培训计划的时间范围内
   - 开始时间 < 结束时间
   - 地点不为空
4. 检查时间冲突：
   - 同一讲师同一时间不能有多个课程
   - 同一地点同一时间不能有多个课程
5. 生成 `item_id`（自增）
6. 插入 `plan_course_item` 表
7. 为该计划的所有员工自动创建 `attendance_evaluation` 记录（初始为空）
8. 返回新创建的课程安排信息
9. 异常情况：
   - 时间冲突：返回 "时间冲突"
   - 参数验证失败：返回具体错误信息

#### 接口路径

```txt
POST /api/planner/course-items
```

#### 请求方式

POST

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**请求体：**

```json
{
  "planId": number,              // 必填，培训计划ID
  "courseId": number,            // 必填，课程ID
  "classDate": "string",         // 必填，上课日期（YYYY-MM-DD）
  "classBeginTime": "string",    // 必填，开始时间（HH:mm:ss）
  "classEndTime": "string",      // 必填，结束时间（HH:mm:ss）
  "location": "string"           // 必填，上课地点
}
```

**参数说明：**

| 参数名 | 类型 | 必填 | 说明 | 数据库字段 |
|--------|------|------|------|-----------|
| planId | number | 是 | 培训计划ID | plan_course_item.plan_id |
| courseId | number | 是 | 课程ID | plan_course_item.course_id |
| classDate | string | 是 | 上课日期，格式YYYY-MM-DD | plan_course_item.class_date |
| classBeginTime | string | 是 | 开始时间，格式HH:mm:ss | plan_course_item.class_begin_time |
| classEndTime | string | 是 | 结束时间，格式HH:mm:ss | plan_course_item.class_end_time |
| location | string | 是 | 上课地点，长度最多100字符 | plan_course_item.location |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "itemId": 10001,
    "planId": 1001,
    "planName": "2024年新员工培训计划",
    "courseId": 5001,
    "courseName": "船舶安全基础",
    "classDate": "2024-01-15",
    "classBeginTime": "09:00:00",
    "classEndTime": "11:00:00",
    "location": "培训室A"
  }
}
```

**时间冲突响应（400）：**

```json
{
  "code": 400,
  "message": "时间冲突：讲师李老师在该时间段已有其他课程安排",
  "data": null
}
```

---

### 5.14 修改课程安排

#### 接口名称

修改课程安排接口

#### 逻辑描述

1. 前端提交修改的课程安排信息，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可修改）
3. 验证 `item_id` 是否存在
4. 验证数据合法性（同创建接口）
5. 检查时间冲突（排除当前记录）
6. 更新 `plan_course_item` 表对应记录
7. 返回更新后的课程安排信息
8. 异常情况：
   - 课程安排不存在：返回 "课程安排不存在"
   - 时间冲突：返回 "时间冲突"

#### 接口路径

```txt
PUT /api/planner/course-items/:itemId
```

#### 请求方式

PUT

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**路径参数：**

| 参数名 | 类型 | 说明 | 数据库字段 |
|--------|------|------|-----------|
| itemId | number | 课程安排ID | plan_course_item.item_id |

**请求体：**

```json
{
  "classDate": "string",         // 可选，上课日期
  "classBeginTime": "string",    // 可选，开始时间
  "classEndTime": "string",      // 可选，结束时间
  "location": "string"           // 可选，上课地点
}
```

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "修改成功",
  "data": {
    "itemId": 10001,
    "planId": 1001,
    "planName": "2024年新员工培训计划",
    "courseId": 5001,
    "courseName": "船舶安全基础",
    "classDate": "2024-01-16",
    "classBeginTime": "09:00:00",
    "classEndTime": "11:00:00",
    "location": "培训室B"
  }
}
```

---

### 5.15 删除课程安排

#### 接口名称

删除课程安排接口

#### 逻辑描述

1. 前端提交要删除的课程安排ID，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可删除）
3. 验证 `item_id` 是否存在
4. 检查是否存在关联数据：
   - 检查 `attendance_evaluation` 表，是否有员工评价记录
5. 如果存在评价记录，返回警告（建议不要删除，或提供强制删除选项）
6. 开启事务：
   - 删除 `attendance_evaluation` 表对应记录（如果强制删除）
   - 删除 `plan_course_item` 表对应记录
7. 返回删除成功信息
8. 异常情况：
   - 课程安排不存在：返回 "课程安排不存在"

#### 接口路径

```txt
DELETE /api/planner/course-items/:itemId
```

#### 请求方式

DELETE

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**路径参数：**

| 参数名 | 类型 | 说明 | 数据库字段 |
|--------|------|------|-----------|
| itemId | number | 课程安排ID | plan_course_item.item_id |

**查询参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| force | boolean | 否 | 是否强制删除（同时删除评价记录），默认false |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**存在评价记录警告响应（400）：**

```json
{
  "code": 400,
  "message": "该课程安排已有员工评价记录，建议不要删除。如需强制删除，请添加force=true参数",
  "data": {
    "evaluationCount": 30
  }
}
```

---

### 5.16 获取平台数据分析

#### 接口名称

获取平台数据分析接口

#### 逻辑描述

1. 前端请求平台整体数据分析，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可访问）
3. 查询并统计多维度数据：
   - **课程评分排名**：查询 `v_course_score` 视图，按平均分排序
   - **培训计划评分排名**：查询 `v_plan_score` 视图，按平均分排序
   - **课程类型分布**：统计各课程类型的课程数和平均分
   - **培训计划进度统计**：统计各状态（规划中/进行中/已完成）的计划数
   - **员工成绩排名**：计算各员工的整体平均分，排序
   - **讲师授课统计**：统计各讲师的授课数和平均评分
4. 返回综合数据分析结果
5. 异常情况：
   - 无权限：返回 "无权限访问"

#### 接口路径

```txt
GET /api/planner/analytics
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**查询参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| topN | number | 否 | 返回排名前N的数据，默认10 |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "courseRankings": [
      {
        "courseId": 5001,
        "courseName": "船舶安全基础",
        "courseAvgScore": 92.5,
        "studentCount": 50
      }
    ],
    "planRankings": [
      {
        "planId": 1001,
        "planName": "2024年新员工培训计划",
        "planAvgScore": 88.3
      }
    ],
    "courseClassDistribution": [
      {
        "courseClass": "安全培训",
        "courseCount": 12,
        "avgScore": 90.2
      }
    ],
    "planStatusStatistics": [
      {
        "planStatus": "规划中",
        "count": 3
      },
      {
        "planStatus": "进行中",
        "count": 5
      },
      {
        "planStatus": "已完成",
        "count": 8
      }
    ],
    "employeeRankings": [
      {
        "personId": 3001,
        "personName": "王员工",
        "avgScore": 95.2,
        "courseCount": 15
      }
    ],
    "teacherStatistics": [
      {
        "teacherId": 4001,
        "teacherName": "李老师",
        "courseCount": 10,
        "avgScore": 91.5,
        "studentCount": 120
      }
    ]
  }
}
```

**参数说明（数据库字段映射）：**

| 前端字段 | 数据库来源 | 说明 |
|---------|-----------|------|
| courseRankings[].courseId | v_course_score.course_id | 课程ID |
| courseRankings[].courseName | v_course_score.course_name | 课程名称 |
| courseRankings[].courseAvgScore | v_course_score.course_avg_score | 课程平均分 |
| courseRankings[].studentCount | v_course_score.student_count | 参与学员数 |
| planRankings[].planId | v_plan_score.plan_id | 培训计划ID |
| planRankings[].planName | v_plan_score.plan_name | 培训计划名称 |
| planRankings[].planAvgScore | v_plan_score.plan_avg_score | 计划平均分 |
| courseClassDistribution[].courseClass | course.course_class | 课程类型 |
| courseClassDistribution[].courseCount | COUNT(course.course_id) | 课程数 |
| courseClassDistribution[].avgScore | AVG(v_course_score.course_avg_score) | 平均分 |
| planStatusStatistics[].planStatus | training_plan.plan_status | 计划状态 |
| planStatusStatistics[].count | COUNT(training_plan.plan_id) | 计划数 |
| employeeRankings[].personId | person.person_id | 员工ID |
| employeeRankings[].personName | person.name | 员工姓名 |
| employeeRankings[].avgScore | AVG(v_employee_item_score.weighted_score) | 平均分 |
| employeeRankings[].courseCount | COUNT(v_employee_item_score.item_id) | 课程数 |
| teacherStatistics[].teacherId | person.person_id | 讲师ID |
| teacherStatistics[].teacherName | person.name | 讲师姓名 |
| teacherStatistics[].courseCount | COUNT(course.course_id) | 授课数 |
| teacherStatistics[].avgScore | AVG(v_course_score.course_avg_score) | 平均评分 |
| teacherStatistics[].studentCount | SUM(v_course_score.student_count) | 学员总数 |

---

### 5.17 获取员工成绩详情

#### 接口名称

获取员工成绩详情接口

#### 逻辑描述

1. 前端请求指定员工的成绩详情，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可访问）
3. 查询 `v_employee_item_score` 视图，获取该员工所有课程的详细成绩
4. 查询 `v_employee_course_score` 视图，获取该员工各课程类型的平均分
5. 计算该员工的整体平均分
6. 返回员工成绩完整信息
7. 异常情况：
   - 员工不存在：返回 "员工不存在"

#### 接口路径

```txt
GET /api/planner/employees/:employeeId/scores
```

#### 请求方式

GET

#### 输入参数

**请求头：**

```txt
Authorization: Bearer <token>
```

**路径参数：**

| 参数名 | 类型 | 说明 | 数据库字段 |
|--------|------|------|-----------|
| employeeId | number | 员工ID | person.person_id |

#### 返回值

**成功响应（200）：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "personId": 3001,
    "personName": "王员工",
    "overallAvgScore": 92.5,
    "courseCount": 15,
    "courseClassScores": [
      {
        "courseClass": "安全培训",
        "avgWeightedScore": 93.2
      }
    ],
    "itemScores": [
      {
        "itemId": 10001,
        "courseName": "船舶安全基础",
        "courseClass": "安全培训",
        "classDate": "2024-01-15",
        "classBeginTime": "09:00:00",
        "classEndTime": "11:00:00",
        "selfScore": 90.0,
        "teacherScore": 95.0,
        "weightedScore": 92.5
      }
    ]
  }
}
```

**参数说明（数据库字段映射）：**

| 前端字段 | 数据库来源 | 说明 |
|---------|-----------|------|
| personId | person.person_id | 员工ID |
| personName | person.name | 员工姓名 |
| overallAvgScore | AVG(v_employee_item_score.weighted_score) | 整体平均分 |
| courseCount | COUNT(v_employee_item_score.item_id) | 课程数 |
| courseClassScores[].courseClass | v_employee_course_score.course_class | 课程类型 |
| courseClassScores[].avgWeightedScore | v_employee_course_score.avg_weighted_score | 类型平均分 |
| itemScores[] | v_employee_item_score | 每节课详细成绩 |

---

### 5.18 获取课程评价详情

#### 接口名称

获取课程评价详情接口

#### 逻辑描述

1. 前端请求指定课程的评价详情，携带 Token
2. 后端验证用户身份和权限（仅课程大纲制定者可访问）
3. 查询 `v_employee_item_score` 视图，获取该课程所有员工的评价和成绩
4. 查询 `v_course_score` 视图，获取课程整体统计
5. 计算课程的平均分、最高分、最低分
6. 返回课程评价完整信息
7. 异常情况：
   - 课程不存在：返回 "课程不存在"

#### 接口路径

```txt
GET /api/planner/courses/:courseId/evaluations
```

#### 请求方式

GET

#### 输入参数

**请求头：**
```txt
Authorization: Bearer <token>
```

**路径参数：**
| 参数名 | 类型 | 说明 | 数据库字段 |
|--------|------|------|-----------|
| courseId | number | 课程ID | course.course_id |

#### 返回值

**成功响应（200）：**
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "courseId": 5001,
    "courseName": "船舶安全基础",
    "courseAvgScore": 92.5,
    "studentCount": 50,
    "maxScore": 98.0,
    "minScore": 75.0,
    "evaluations": [
      {
        "personId": 3001,
        "personName": "王员工",
        "itemId": 10001,
        "classDate": "2024-01-15",
        "selfScore": 90.0,
        "selfComment": "课程内容非常实用，讲师讲解清晰",
        "teacherScore": 95.0,
        "teacherComment": "表现优秀，积极参与互动",
        "weightedScore": 92.5
      }
    ]
  }
}
```

**参数说明（数据库字段映射）：**
| 前端字段 | 数据库来源 | 说明 |
|---------|-----------|------|
| courseId | course.course_id | 课程ID |
| courseName | course.course_name | 课程名称 |
| courseAvgScore | v_course_score.course_avg_score | 课程平均分 |
| studentCount | v_course_score.student_count | 学员人数 |
| maxScore | MAX(v_employee_item_score.weighted_score) | 最高分 |
| minScore | MIN(v_employee_item_score.weighted_score) | 最低分 |
| evaluations[].personId | v_employee_item_score.person_id | 员工ID |
| evaluations[].personName | v_employee_item_score.person_name | 员工姓名 |
| evaluations[].itemId | v_employee_item_score.item_id | 课程安排ID |
| evaluations[].classDate | v_employee_item_score.class_date | 上课日期 |
| evaluations[].selfScore | attendance_evaluation.self_score | 自评分 |
| evaluations[].selfComment | attendance_evaluation.self_comment | 自评内容 |
| evaluations[].teacherScore | attendance_evaluation.teacher_score | 讲师评分 |
| evaluations[].teacherComment | attendance_evaluation.teacher_comment | 讲师评语 |
| evaluations[].weightedScore | v_employee_item_score.weighted_score | 加权得分 |
